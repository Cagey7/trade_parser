import os
import pytest
import psycopg2
from decimal import Decimal
import math

digit = 4

EXPECTED_IM_VALUES_CU = { #statgov
    'Республика Казахстан': {
        (2023, 1): 1_229_970,
        (2023, 2): 1_375_678,
        (2023, 3): 1_629_068,
        (2023, 4): 1_510_795,
        (2023, 5): 1_666_364,
        (2023, 6): 1_533_444,
        (2023, 7): 1_537_001,
        (2023, 8): 1_421_339,
        (2023, 9): 1_432_235,
        (2023, 10): 1_458_677,
        (2023, 11): 1_612_440,
        (2023, 12): 1_814_484,
        (2024, 1): 1_222_574,
        (2024, 2): 1_336_409,
        (2024, 3): 1_603_530,
        (2024, 4): 1_490_743,
        (2024, 5): 1_564_303,
        (2024, 6): 1_773_357,
        (2024, 7): 1_694_160,
        (2024, 8): 1_773_714,
        (2024, 9): 1_677_154,
        (2024, 10): 1_759_762,
        (2024, 11): 1_687_132,
        (2024, 12): 1_886_950,
        (2025, 1): 1_162_499,
        (2025, 2): 1_348_819,
        (2025, 3): 1_501_724,
        (2025, 4): 3924536,
    },
    'Астана': {
        (2025, 1): 248074,
        (2025, 2): 294291,
        (2025, 3): 297214,

        (2024, 1): 219150,
        (2024, 2): 262857,
        (2024, 3): 334487,
        (2024, 4): 269230,
        (2024, 5): 305226,
        (2024, 6): 454366,
        (2024, 7): 430481,
        (2024, 8): 525952,
        (2024, 9): 316106,
        (2024, 10): 302809,
        (2024, 11): 409542,
        (2024, 12): 530693,
        
        (2023, 1): 180175,
        (2023, 2): 305674,
        (2023, 3): 365089,
        (2023, 4): 260212,
        (2023, 5): 311785,
        (2023, 6): 270055,
        (2023, 7): 359997,
        (2023, 8): 325851,
        (2023, 9): 326317,
        (2023, 10): 246129,
        (2023, 11): 298580,
        (2023, 12): 497656,
    },
    'Алматы': {
        (2025, 1): 394334,
        (2025, 2): 414591,
        (2025, 3): 489250,

        (2024, 1): 399127,
        (2024, 2): 392793,
        (2024, 3): 421563,
        (2024, 4): 398028,
        (2024, 5): 418196,
        (2024, 6): 385409,
        (2024, 7): 391900,
        (2024, 8): 422175,
        (2024, 9): 555118,
        (2024, 10): 494770,
        (2024, 11): 508886,
        (2024, 12): 501057,
        
        (2023, 1): 332633,
        (2023, 2): 328459,
        (2023, 3): 386833,
        (2023, 4): 439716,
        (2023, 5): 464998,
        (2023, 6): 497582,
        (2023, 7): 439313,
        (2023, 8): 419192,
        (2023, 9): 399517,
        (2023, 10): 451887,
        (2023, 11): 471793,
        (2023, 12): 485728,
    },
    'Шымкент': {
        (2025, 1): 24519,
        (2025, 2): 32130,
        (2025, 3): 38512,

        (2024, 1): 33615,
        (2024, 2): 41626,
        (2024, 3): 49470,
        (2024, 4): 49716,
        (2024, 5): 45647,
        (2024, 6): 48418,
        (2024, 7): 43115,
        (2024, 8): 42325,
        (2024, 9): 41452,
        (2024, 10): 41506,
        (2024, 11): 36544,
        (2024, 12): 35043,
        
        (2023, 1): 31573,
        (2023, 2): 35698,
        (2023, 3): 49204,
        (2023, 4): 48155,
        (2023, 5): 47280,
        (2023, 6): 48195,
        (2023, 7): 51687,
        (2023, 8): 59426,
        (2023, 9): 51177,
        (2023, 10): 49321,
        (2023, 11): 81243,
        (2023, 12): 46894,
    },
    'область Абай': {
        (2025, 1): 18867,
        (2025, 2): 19397,
        (2025, 3): 32145,

        (2024, 1): 46783,
        (2024, 2): 42458,
        (2024, 3): 24646,
        (2024, 4): 112654,
        (2024, 5): 89979,
        (2024, 6): 92807,
        (2024, 7): 85478,
        (2024, 8): 81329,
        (2024, 9): 75834,
        (2024, 10): 76152,
        (2024, 11): 54612,
        (2024, 12): 97970,
        
        (2023, 1): 29268,
        (2023, 2): 36756,
        (2023, 3): 55711,
        (2023, 4): 28945,
        (2023, 5): 36983,
        (2023, 6): 30798,
        (2023, 7): 24659,
        (2023, 8): 26397,
        (2023, 9): 29276,
        (2023, 10): 29302,
        (2023, 11): 35172,
        (2023, 12): 41046,
    },
    'Акмолинская область': {
        (2025, 1): 27105,
        (2025, 2): 28910,
        (2025, 3): 41994,

        (2024, 1): 22987,
        (2024, 2): 25811,
        (2024, 3): 30189,
        (2024, 4): 42519,
        (2024, 5): 43137,
        (2024, 6): 36070,
        (2024, 7): 42815,
        (2024, 8): 37656,
        (2024, 9): 30632,
        (2024, 10): 34208,
        (2024, 11): 41352,
        (2024, 12): 34812,
        
        (2023, 1): 30823,
        (2023, 2): 36888,
        (2023, 3): 45954,
        (2023, 4): 39398,
        (2023, 5): 41001,
        (2023, 6): 38851,
        (2023, 7): 34002,
        (2023, 8): 34803,
        (2023, 9): 31127,
        (2023, 10): 29356,
        (2023, 11): 34823,
        (2023, 12): 33465,
    },
    'Актюбинская область': {
        (2025, 1): 43393,
        (2025, 2): 46805,
        (2025, 3): 55732,

        (2024, 1): 83790,
        (2024, 2): 83273,
        (2024, 3): 121634,
        (2024, 4): 76359,
        (2024, 5): 95532,
        (2024, 6): 81297,
        (2024, 7): 107292,
        (2024, 8): 62173,
        (2024, 9): 106689,
        (2024, 10): 106639,
        (2024, 11): 105046,
        (2024, 12): 89471,
        
        (2023, 1): 60391,
        (2023, 2): 58543,
        (2023, 3): 75888,
        (2023, 4): 64692,
        (2023, 5): 70175,
        (2023, 6): 71433,
        (2023, 7): 69134,
        (2023, 8): 55903,
        (2023, 9): 64388,
        (2023, 10): 73754,
        (2023, 11): 120134,
        (2023, 12): 109535,
    },
    'Алматинская область': {
        (2025, 1): 40476,
        (2025, 2): 59031,
        (2025, 3): 63215,

        (2024, 1): 38268,
        (2024, 2): 43622,
        (2024, 3): 55996,
        (2024, 4): 50598,
        (2024, 5): 84206,
        (2024, 6): 53023,
        (2024, 7): 53319,
        (2024, 8): 53790,
        (2024, 9): 55835,
        (2024, 10): 61179,
        (2024, 11): 64871,
        (2024, 12): 69178,
        
        (2023, 1): 45841,
        (2023, 2): 53509,
        (2023, 3): 67205,
        (2023, 4): 61701,
        (2023, 5): 71826,
        (2023, 6): 66266,
        (2023, 7): 59035,
        (2023, 8): 49701,
        (2023, 9): 46858,
        (2023, 10): 48072,
        (2023, 11): 55150,
        (2023, 12): 56264,
    },
    'Атырауская область': {
        (2025, 1): 20049,
        (2025, 2): 18082,
        (2025, 3): 19898,

        (2024, 1): 20145,
        (2024, 2): 20629,
        (2024, 3): 23963,
        (2024, 4): 20457,
        (2024, 5): 16913,
        (2024, 6): 18114,
        (2024, 7): 20028,
        (2024, 8): 28762,
        (2024, 9): 21706,
        (2024, 10): 26361,
        (2024, 11): 21613,
        (2024, 12): 24476,
        
        (2023, 1): 27031,
        (2023, 2): 26457,
        (2023, 3): 23352,
        (2023, 4): 21349,
        (2023, 5): 24892,
        (2023, 6): 22147,
        (2023, 7): 25285,
        (2023, 8): 22280,
        (2023, 9): 24439,
        (2023, 10): 30143,
        (2023, 11): 31012,
        (2023, 12): 26635,
    },
    'Восточно-Казахстанская область': {
        (2025, 1): 41491,
        (2025, 2): 44664,
        (2025, 3): 54034,

        (2024, 1): 46207,
        (2024, 2): 60296,
        (2024, 3): 67729,
        (2024, 4): 70464,
        (2024, 5): 58715,
        (2024, 6): 166596,
        (2024, 7): 76748,
        (2024, 8): 99639,
        (2024, 9): 68745,
        (2024, 10): 69612,
        (2024, 11): 79701,
        (2024, 12): 57526,
        
        (2023, 1): 88643,
        (2023, 2): 112437,
        (2023, 3): 125424,
        (2023, 4): 121456,
        (2023, 5): 137011,
        (2023, 6): 81834,
        (2023, 7): 81867,
        (2023, 8): 68945,
        (2023, 9): 60752,
        (2023, 10): 71296,
        (2023, 11): 76501,
        (2023, 12): 84593,
    },
    'Жамбылская область': {
        (2025, 1): 12881,
        (2025, 2): 22875,
        (2025, 3): 15346,
        
        (2024, 1): 9422,
        (2024, 2): 12510,
        (2024, 3): 10979,
        (2024, 4): 11596,
        (2024, 5): 12811,
        (2024, 6): 15487,
        (2024, 7): 14470,
        (2024, 8): 14048,
        (2024, 9): 14806,
        (2024, 10): 15267,
        (2024, 11): 16855,
        (2024, 12): 23624,
        
        (2023, 1): 19927,
        (2023, 2): 20284,
        (2023, 3): 22309,
        (2023, 4): 19295,
        (2023, 5): 21030,
        (2023, 6): 19840,
        (2023, 7): 50601,
        (2023, 8): 16223,
        (2023, 9): 40133,
        (2023, 10): 13789,
        (2023, 11): 15798,
        (2023, 12): 16843,
    },
    'область Жетісу': {
        (2025, 1): 1416,
        (2025, 2): 3855,
        (2025, 3): 4282,

        (2024, 1): 3297,
        (2024, 2): 3816,
        (2024, 3): 6072,
        (2024, 4): 7034,
        (2024, 5): 7885,
        (2024, 6): 4309,
        (2024, 7): 4229,
        (2024, 8): 4645,
        (2024, 9): 4916,
        (2024, 10): 3461,
        (2024, 11): 6077,
        (2024, 12): 3498,
        
        (2023, 1): 4352,
        (2023, 2): 5875,
        (2023, 3): 6311,
        (2023, 4): 7780,
        (2023, 5): 4880,
        (2023, 6): 4452,
        (2023, 7): 4834,
        (2023, 8): 3316,
        (2023, 9): 3377,
        (2023, 10): 3919,
        (2023, 11): 3515,
        (2023, 12): 4198,
    },
    'Западно-Казахстанская область': {
        (2025, 1): 50186,
        (2025, 2): 47056,
        (2025, 3): 64554,

        (2024, 1): 43395,
        (2024, 2): 51970,
        (2024, 3): 47051,
        (2024, 4): 37276,
        (2024, 5): 40132,
        (2024, 6): 54496,
        (2024, 7): 57510,
        (2024, 8): 56970,
        (2024, 9): 56316,
        (2024, 10): 79668,
        (2024, 11): 55102,
        (2024, 12): 56319,
        
        (2023, 1): 61431,
        (2023, 2): 46611,
        (2023, 3): 51610,
        (2023, 4): 63036,
        (2023, 5): 73066,
        (2023, 6): 59788,
        (2023, 7): 43582,
        (2023, 8): 47969,
        (2023, 9): 54885,
        (2023, 10): 69523,
        (2023, 11): 53101,
        (2023, 12): 59040,
    },
    'Карагандинская область': {
        (2025, 1): 75813,
        (2025, 2): 90830,
        (2025, 3): 101481,

        (2024, 1): 74655,
        (2024, 2): 88690,
        (2024, 3): 107272,
        (2024, 4): 113596,
        (2024, 5): 103564,
        (2024, 6): 102098,
        (2024, 7): 106627,
        (2024, 8): 110188,
        (2024, 9): 96871,
        (2024, 10): 105094,
        (2024, 11): 79382,
        (2024, 12): 99142,
        
        (2023, 1): 95438,
        (2023, 2): 96666,
        (2023, 3): 92085,
        (2023, 4): 90357,
        (2023, 5): 109018,
        (2023, 6): 92718,
        (2023, 7): 81022,
        (2023, 8): 80506,
        (2023, 9): 85796,
        (2023, 10): 87702,
        (2023, 11): 95673,
        (2023, 12): 87087,
    },
    'Костанайская область': {
        (2025, 1): 57129,
        (2025, 2): 74160,
        (2025, 3): 60611,

        (2024, 1): 73212,
        (2024, 2): 76932,
        (2024, 3): 92398,
        (2024, 4): 80300,
        (2024, 5): 86691,
        (2024, 6): 93062,
        (2024, 7): 94964,
        (2024, 8): 78744,
        (2024, 9): 80398,
        (2024, 10): 84347,
        (2024, 11): 76572,
        (2024, 12): 79823,
        
        (2023, 1): 88396,
        (2023, 2): 96121,
        (2023, 3): 106022,
        (2023, 4): 98712,
        (2023, 5): 89231,
        (2023, 6): 86934,
        (2023, 7): 78093,
        (2023, 8): 67555,
        (2023, 9): 78467,
        (2023, 10): 82077,
        (2023, 11): 82803,
        (2023, 12): 87475,
    },
    'Кызылординская область': {
        (2025, 1): 2708,
        (2025, 2): 4773,
        (2025, 3): 3491,

        (2024, 1): 4564,
        (2024, 2): 3282,
        (2024, 3): 4714,
        (2024, 4): 6554,
        (2024, 5): 7463,
        (2024, 6): 5777,
        (2024, 7): 5082,
        (2024, 8): 5869,
        (2024, 9): 6686,
        (2024, 10): 5019,
        (2024, 11): 5643,
        (2024, 12): 6127,
        
        (2023, 1): 4177,
        (2023, 2): 4476,
        (2023, 3): 3889,
        (2023, 4): 4626,
        (2023, 5): 4054,
        (2023, 6): 4028,
        (2023, 7): 3466,
        (2023, 8): 3538,
        (2023, 9): 4580,
        (2023, 10): 4305,
        (2023, 11): 5669,
        (2023, 12): 6555,
    },
    'Мангистауская область': {
        (2025, 1): 11540,
        (2025, 2): 17319,
        (2025, 3): 15715,

        (2024, 1): 9512,
        (2024, 2): 12557,
        (2024, 3): 15626,
        (2024, 4): 13883,
        (2024, 5): 16093,
        (2024, 6): 21121,
        (2024, 7): 19340,
        (2024, 8): 17400,
        (2024, 9): 17003,
        (2024, 10): 22670,
        (2024, 11): 16328,
        (2024, 12): 16143,
        
        (2023, 1): 26928,
        (2023, 2): 12052,
        (2023, 3): 17332,
        (2023, 4): 12294,
        (2023, 5): 21168,
        (2023, 6): 14523,
        (2023, 7): 14590,
        (2023, 8): 13023,
        (2023, 9): 12582,
        (2023, 10): 16278,
        (2023, 11): 14897,
        (2023, 12): 21510,
    },
    'Павлодарская область': {
        (2025, 1): 44884,
        (2025, 2): 53584,
        (2025, 3): 68235,

        (2024, 1): 50670,
        (2024, 2): 55266,
        (2024, 3): 114149,
        (2024, 4): 61933,
        (2024, 5): 58379,
        (2024, 6): 62415,
        (2024, 7): 70398,
        (2024, 8): 60937,
        (2024, 9): 57473,
        (2024, 10): 76035,
        (2024, 11): 52950,
        (2024, 12): 0, #проблема
        
        (2023, 1): 64716,
        (2023, 2): 50982,
        (2023, 3): 71856,
        (2023, 4): 62589,
        (2023, 5): 69939,
        (2023, 6): 64287,
        (2023, 7): 64062,
        (2023, 8): 72604,
        (2023, 9): 69912,
        (2023, 10): 88512,
        (2023, 11): 79399,
        (2023, 12): 74289,
    },
    'Северо-Казахстанская область': {
        (2025, 1): 24336,
        (2025, 2): 48584,
        (2025, 3): 38777,

        (2024, 1): 26762,
        (2024, 2): 40548,
        (2024, 3): 49669,
        (2024, 4): 48910,
        (2024, 5): 53338,
        (2024, 6): 55915,
        (2024, 7): 50140,
        (2024, 8): 44164,
        (2024, 9): 39940,
        (2024, 10): 127936,
        (2024, 11): 35962,
        (2024, 12): 36481,
        
        (2023, 1): 28912,
        (2023, 2): 37410,
        (2023, 3): 45998,
        (2023, 4): 50808,
        (2023, 5): 51080,
        (2023, 6): 44499,
        (2023, 7): 35622,
        (2023, 8): 40881,
        (2023, 9): 32730,
        (2023, 10): 43164,
        (2023, 11): 42718,
        (2023, 12): 52743,
    },
    'Туркестанская область': {
        (2025, 1): 21326,
        (2025, 2): 25641,
        (2025, 3): 33633,

        (2024, 1): 10095,
        (2024, 2): 13645,
        (2024, 3): 22025,
        (2024, 4): 15958,
        (2024, 5): 16891,
        (2024, 6): 19852,
        (2024, 7): 16977,
        (2024, 8): 23226,
        (2024, 9): 27557,
        (2024, 10): 24900,
        (2024, 11): 18920,
        (2024, 12): 25707,
        
        (2023, 1): 6497,
        (2023, 2): 8902,
        (2023, 3): 9640,
        (2023, 4): 12051,
        (2023, 5): 11979,
        (2023, 6): 10895,
        (2023, 7): 11448,
        (2023, 8): 10534,
        (2023, 9): 11284,
        (2023, 10): 12931,
        (2023, 11): 9748,
        (2023, 12): 13625,
    },
    'область Ұлытау': {
        (2025, 1): 1964,
        (2025, 2): 2231,
        (2025, 3): 3600,

        (2024, 1): 6908,
        (2024, 2): 3821,
        (2024, 3): 3891,
        (2024, 4): 3670,
        (2024, 5): 3496,
        (2024, 6): 2715,
        (2024, 7): 3239,
        (2024, 8): 3715,
        (2024, 9): 3063,
        (2024, 10): 2119,
        (2024, 11): 1167,
        (2024, 12): 3103,
        
        (2023, 1): 2807,
        (2023, 2): 1869,
        (2023, 3): 7346,
        (2023, 4): 3613,
        (2023, 5): 4957,
        (2023, 6): 4309,
        (2023, 7): 4695,
        (2023, 8): 2685,
        (2023, 9): 4629,
        (2023, 10): 7209,
        (2023, 11): 4701,
        (2023, 12): 9295,
    }
}


EXPECTED_IM_VALUES = { #kgd
    'Республика Казахстан': {
        
        (2023, 1): 3_031_184,
        (2023, 2): 3_216_175,
        (2023, 3): 3_786_231,
        (2023, 4): 3_541_790,
        (2023, 5): 3_754_049,
        (2023, 6): 3_615_781,
        (2023, 7): 3_842_962,
        (2023, 8): 3_687_533,
        (2023, 9): 3_293_023,
        (2023, 10): 3_515_798,
        (2023, 11): 3_507_690,
        (2023, 12): 3_398_563,
        (2024, 1): 3_063_543,
        (2024, 2): 2_732_402,
        (2024, 3): 2_948_488,
        (2024, 4): 3_682_158,
        (2024, 5): 3_611_406,
        (2024, 6): 3_133_979,
        (2024, 7): 3_523_729,
        (2024, 8): 3_410_079,
        (2024, 9): 3_231_135,
        (2024, 10): 3_682_380,
        (2024, 11): 3_499_215,
        (2024, 12): 3_798_995,
        (2025, 1): 2_872_814,
        (2025, 2): 2_876_468,
        (2025, 3): 3_148_816,
    },
    'Астана': {
        (2025, 1): 331_210,
        (2025, 2): 294_874,
        (2025, 3): 317_187,

        (2024, 1): 310596,
        (2024, 2): 246755,
        (2024, 3): 344734,
        (2024, 4): 396223,
        (2024, 5): 415127,
        (2024, 6): 374379,
        (2024, 7): 333016,
        (2024, 8): 346862,
        (2024, 9): 332337,
        (2024, 10): 349638,
        (2024, 11): 358916,
        (2024, 12): 679972,
        
        (2023, 1): 259577,
        (2023, 2): 287407,
        (2023, 3): 361939,
        (2023, 4): 358037,
        (2023, 5): 367914,
        (2023, 6): 343591,
        (2023, 7): 429370,
        (2023, 8): 402348,
        (2023, 9): 300609,
        (2023, 10): 343561,
        (2023, 11): 473530,
        (2023, 12): 503195,
    },
    'Алматы': {
        (2025, 1): 1461974,
        (2025, 2): 1462253,
        (2025, 3): 1685166,

        (2024, 1): 1618607,
        (2024, 2): 1448624,
        (2024, 3): 1481098,
        (2024, 4): 1936925,
        (2024, 5): 1877543,
        (2024, 6): 1543994,
        (2024, 7): 1791555,
        (2024, 8): 1717851,
        (2024, 9): 1500976,
        (2024, 10): 1830970,
        (2024, 11): 1864869,
        (2024, 12): 1817251,
        
        (2023, 1): 1567984,
        (2023, 2): 1552528,
        (2023, 3): 1802665,
        (2023, 4): 1619549,
        (2023, 5): 1676193,
        (2023, 6): 1768204,
        (2023, 7): 1910081,
        (2023, 8): 1797577,
        (2023, 9): 1603139,
        (2023, 10): 1788335,
        (2023, 11): 1783732,
        (2023, 12): 1595896,
    },
    'Шымкент': {
        (2025, 1): 98920,
        (2025, 2): 87500,
        (2025, 3): 86176,

        (2024, 1): 89948,
        (2024, 2): 90263,
        (2024, 3): 86598,
        (2024, 4): 103223,
        (2024, 5): 103667,
        (2024, 6): 120690,
        (2024, 7): 109859,
        (2024, 8): 80036,
        (2024, 9): 128946,
        (2024, 10): 136840,
        (2024, 11): 126048,
        (2024, 12): 108504,
        
        (2023, 1): 77627,
        (2023, 2): 128952,
        (2023, 3): 100745,
        (2023, 4): 141512,
        (2023, 5): 97754,
        (2023, 6): 83887,
        (2023, 7): 123980,
        (2023, 8): 125211,
        (2023, 9): 89615,
        (2023, 10): 96573,
        (2023, 11): 90112,
        (2023, 12): 111023,
    },
    'область Абай': {
        (2025, 1): 27075,
        (2025, 2): 19153,
        (2025, 3): 27177,

        (2024, 1): 22157,
        (2024, 2): 17686,
        (2024, 3): 22743,
        (2024, 4): 25424,
        (2024, 5): 26295,
        (2024, 6): 22499,
        (2024, 7): 25111,
        (2024, 8): 27660,
        (2024, 9): 31829,
        (2024, 10): 27154,
        (2024, 11): 35036,
        (2024, 12): 31676,
        
        (2023, 1): 17515,
        (2023, 2): 16403,
        (2023, 3): 17123,
        (2023, 4): 19790,
        (2023, 5): 17134,
        (2023, 6): 14134,
        (2023, 7): 15883,
        (2023, 8): 17608,
        (2023, 9): 30670,
        (2023, 10): 15707,
        (2023, 11): 19806,
        (2023, 12): 18213,
    },
    'Акмолинская область': {
        (2025, 1): 31040,
        (2025, 2): 34347,
        (2025, 3): 35401,

        (2024, 1): 22969,
        (2024, 2): 32406,
        (2024, 3): 32034,
        (2024, 4): 49990,
        (2024, 5): 63274,
        (2024, 6): 38173,
        (2024, 7): 46624,
        (2024, 8): 42374,
        (2024, 9): 27084,
        (2024, 10): 36951,
        (2024, 11): 34263,
        (2024, 12): 29851,
        
        (2023, 1): 41107,
        (2023, 2): 60334,
        (2023, 3): 65649,
        (2023, 4): 100927,
        (2023, 5): 148405,
        (2023, 6): 100542,
        (2023, 7): 79292,
        (2023, 8): 87402,
        (2023, 9): 58962,
        (2023, 10): 37739,
        (2023, 11): 26097,
        (2023, 12): 31891,
    },
    'Актюбинская область': {
        (2025, 1): 36477,
        (2025, 2): 31770,
        (2025, 3): 34819,

        (2024, 1): 49622,
        (2024, 2): 42787,
        (2024, 3): 39273,
        (2024, 4): 49387,
        (2024, 5): 58384,
        (2024, 6): 41287,
        (2024, 7): 39644,
        (2024, 8): 50430,
        (2024, 9): 45443,
        (2024, 10): 46598,
        (2024, 11): 42250,
        (2024, 12): 41274,
        
        (2023, 1): 41981,
        (2023, 2): 41750,
        (2023, 3): 56707,
        (2023, 4): 73895,
        (2023, 5): 67154,
        (2023, 6): 61615,
        (2023, 7): 78853,
        (2023, 8): 58698,
        (2023, 9): 63981,
        (2023, 10): 62068,
        (2023, 11): 50046,
        (2023, 12): 49510,
    },
    'Алматинская область': {
        (2025, 1): 163780,
        (2025, 2): 144930,
        (2025, 3): 165389,

        (2024, 1): 163599,
        (2024, 2): 147505,
        (2024, 3): 145805,
        (2024, 4): 178744,
        (2024, 5): 156386,
        (2024, 6): 165458,
        (2024, 7): 186235,
        (2024, 8): 196408,
        (2024, 9): 178788,
        (2024, 10): 191904,
        (2024, 11): 171717,
        (2024, 12): 186239,
        
        (2023, 1): 160004,
        (2023, 2): 171785,
        (2023, 3): 225675,
        (2023, 4): 200966,
        (2023, 5): 191165,
        (2023, 6): 170470,
        (2023, 7): 184100,
        (2023, 8): 174130,
        (2023, 9): 154309,
        (2023, 10): 164029,
        (2023, 11): 169697,
        (2023, 12): 185256,
    },
    'Атырауская область': {
        (2025, 1): 49380,
        (2025, 2): 54394,
        (2025, 3): 45969,

        (2024, 1): 74939,
        (2024, 2): 69496,
        (2024, 3): 69280,
        (2024, 4): 81001,
        (2024, 5): 73541,
        (2024, 6): 99682,
        (2024, 7): 118102,
        (2024, 8): 107235,
        (2024, 9): 124781,
        (2024, 10): 96698,
        (2024, 11): 75463,
        (2024, 12): 68648,
        
        (2023, 1): 92582,
        (2023, 2): 78149,
        (2023, 3): 80163,
        (2023, 4): 86319,
        (2023, 5): 86634,
        (2023, 6): 85681,
        (2023, 7): 143124,
        (2023, 8): 93812,
        (2023, 9): 77623,
        (2023, 10): 78800,
        (2023, 11): 75422,
        (2023, 12): 72053,
    },
    'Восточно-Казахстанская область': {
        (2025, 1): 41107,
        (2025, 2): 68475,
        (2025, 3): 74471,

        (2024, 1): 61057,
        (2024, 2): 51744,
        (2024, 3): 102063,
        (2024, 4): 111533,
        (2024, 5): 75187,
        (2024, 6): 76324,
        (2024, 7): 78260,
        (2024, 8): 87744,
        (2024, 9): 74128,
        (2024, 10): 101484,
        (2024, 11): 65369,
        (2024, 12): 88849,
        
        (2023, 1): 120469,
        (2023, 2): 149298,
        (2023, 3): 160453,
        (2023, 4): 102729,
        (2023, 5): 106980,
        (2023, 6): 89839,
        (2023, 7): 125880,
        (2023, 8): 69121,
        (2023, 9): 105608,
        (2023, 10): 90974,
        (2023, 11): 86016,
        (2023, 12): 87088,
    },
    'Жамбылская область': {
        (2025, 1): 6536,
        (2025, 2): 7038,
        (2025, 3): 15701,

        (2024, 1): 17808,
        (2024, 2): 11781,
        (2024, 3): 19735,
        (2024, 4): 30777,
        (2024, 5): 36096,
        (2024, 6): 37678,
        (2024, 7): 68551,
        (2024, 8): 28689,
        (2024, 9): 14362,
        (2024, 10): 18573,
        (2024, 11): 11704,
        (2024, 12): 18963,
        
        (2023, 1): 12903,
        (2023, 2): 24211,
        (2023, 3): 26973,
        (2023, 4): 27242,
        (2023, 5): 52099,
        (2023, 6): 41400,
        (2023, 7): 39499,
        (2023, 8): 32412,
        (2023, 9): 25798,
        (2023, 10): 30610,
        (2023, 11): 22225,
        (2023, 12): 27254,
    },
    'область Жетісу': {
        (2025, 1): 142204,
        (2025, 2): 127990,
        (2025, 3): 170972,

        (2024, 1): 187807,
        (2024, 2): 146733,
        (2024, 3): 155641,
        (2024, 4): 199323,
        (2024, 5): 180324,
        (2024, 6): 182107,
        (2024, 7): 229245,
        (2024, 8): 277527,
        (2024, 9): 279352,
        (2024, 10): 232813,
        (2024, 11): 157707,
        (2024, 12): 136727,
        
        (2023, 1): 126485,
        (2023, 2): 146713,
        (2023, 3): 274949,
        (2023, 4): 220053,
        (2023, 5): 252172,
        (2023, 6): 216381,
        (2023, 7): 207839,
        (2023, 8): 326806,
        (2023, 9): 273815,
        (2023, 10): 269160,
        (2023, 11): 229561,
        (2023, 12): 207473,
    },
    'Западно-Казахстанская область': {
        (2025, 1): 37357,
        (2025, 2): 36900,
        (2025, 3): 29499,

        (2024, 1): 35125,
        (2024, 2): 33871,
        (2024, 3): 29924,
        (2024, 4): 39033,
        (2024, 5): 38581,
        (2024, 6): 32887,
        (2024, 7): 33856,
        (2024, 8): 34907,
        (2024, 9): 37873,
        (2024, 10): 38810,
        (2024, 11): 58708,
        (2024, 12): 44106,
        
        (2023, 1): 34271,
        (2023, 2): 37024,
        (2023, 3): 41263,
        (2023, 4): 42767,
        (2023, 5): 52256,
        (2023, 6): 48220,
        (2023, 7): 44874,
        (2023, 8): 39878,
        (2023, 9): 41156,
        (2023, 10): 33414,
        (2023, 11): 48486,
        (2023, 12): 44551,
    },
    'Карагандинская область': {
        (2025, 1): 112253,
        (2025, 2): 96914,
        (2025, 3): 70671,

        (2024, 1): 117892,
        (2024, 2): 101655,
        (2024, 3): 98674,
        (2024, 4): 110959,
        (2024, 5): 151870,
        (2024, 6): 123079,
        (2024, 7): 111620,
        (2024, 8): 99345,
        (2024, 9): 101130,
        (2024, 10): 124240,
        (2024, 11): 115801,
        (2024, 12): 102216,
        
        (2023, 1): 139787,
        (2023, 2): 129848,
        (2023, 3): 162683,
        (2023, 4): 135928,
        (2023, 5): 152043,
        (2023, 6): 147446,
        (2023, 7): 125771,
        (2023, 8): 118872,
        (2023, 9): 115346,
        (2023, 10): 136196,
        (2023, 11): 144970,
        (2023, 12): 130524,
    },
    'Костанайская область': {
        (2025, 1): 187903,
        (2025, 2): 250919,
        (2025, 3): 179405,

        (2024, 1): 176361,
        (2024, 2): 157596,
        (2024, 3): 184230,
        (2024, 4): 237566,
        (2024, 5): 167644,
        (2024, 6): 107799,
        (2024, 7): 155766,
        (2024, 8): 140035,
        (2024, 9): 179258,
        (2024, 10): 180887,
        (2024, 11): 215240,
        (2024, 12): 238664,
        
        (2023, 1): 144842,
        (2023, 2): 207813,
        (2023, 3): 205246,
        (2023, 4): 215921,
        (2023, 5): 230652,
        (2023, 6): 227179,
        (2023, 7): 162057,
        (2023, 8): 181518,
        (2023, 9): 193973,
        (2023, 10): 189506,
        (2023, 11): 147432,
        (2023, 12): 168057,
    },
    'Кызылординская область': {
        (2025, 1): 4928,
        (2025, 2): 15393,
        (2025, 3): 15138,

        (2024, 1): 4256,
        (2024, 2): 3854,
        (2024, 3): 4720,
        (2024, 4): 7892,
        (2024, 5): 9567,
        (2024, 6): 8959,
        (2024, 7): 9192,
        (2024, 8): 9846,
        (2024, 9): 18669,
        (2024, 10): 9167,
        (2024, 11): 7500,
        (2024, 12): 12431,
        
        (2023, 1): 28848,
        (2023, 2): 9255,
        (2023, 3): 9848,
        (2023, 4): 6718,
        (2023, 5): 12238,
        (2023, 6): 10723,
        (2023, 7): 7849,
        (2023, 8): 6250,
        (2023, 9): 6003,
        (2023, 10): 5610,
        (2023, 11): 12551,
        (2023, 12): 9885,
    },
    'Мангистауская область': {
        (2025, 1): 45106,
        (2025, 2): 28198,
        (2025, 3): 32305,

        (2024, 1): 26725,
        (2024, 2): 27210,
        (2024, 3): 30633,
        (2024, 4): 26713,
        (2024, 5): 28293,
        (2024, 6): 32481,
        (2024, 7): 51805,
        (2024, 8): 28537,
        (2024, 9): 28508,
        (2024, 10): 33948,
        (2024, 11): 29677,
        (2024, 12): 50831,
        
        (2023, 1): 57920,
        (2023, 2): 49496,
        (2023, 3): 45772,
        (2023, 4): 61788,
        (2023, 5): 59781,
        (2023, 6): 57059,
        (2023, 7): 43679,
        (2023, 8): 39691,
        (2023, 9): 35532,
        (2023, 10): 32239,
        (2023, 11): 31793,
        (2023, 12): 35914,
    },
    'Павлодарская область': {
        (2025, 1): 29190,
        (2025, 2): 50471,
        (2025, 3): 58540,

        (2024, 1): 31726,
        (2024, 2): 30534,
        (2024, 3): 38764,
        (2024, 4): 29392,
        (2024, 5): 44354,
        (2024, 6): 37315,
        (2024, 7): 45937,
        (2024, 8): 51096,
        (2024, 9): 41471,
        (2024, 10): 41314,
        (2024, 11): 31725,
        (2024, 12): 53789,
        
        (2023, 1): 50025,
        (2023, 2): 52843,
        (2023, 3): 68141,
        (2023, 4): 40493,
        (2023, 5): 76109,
        (2023, 6): 37752,
        (2023, 7): 42449,
        (2023, 8): 52572,
        (2023, 9): 55614,
        (2023, 10): 72823,
        (2023, 11): 37164,
        (2023, 12): 45877,
    },
    'Северо-Казахстанская область': {
        (2025, 1): 16588,
        (2025, 2): 19387,
        (2025, 3): 20387,

        (2024, 1): 12988,
        (2024, 2): 25817,
        (2024, 3): 18201,
        (2024, 4): 21469,
        (2024, 5): 31916,
        (2024, 6): 24009,
        (2024, 7): 28833,
        (2024, 8): 26777,
        (2024, 9): 14134,
        (2024, 10): 15572,
        (2024, 11): 22418,
        (2024, 12): 9651,
        
        (2023, 1): 18148,
        (2023, 2): 27617,
        (2023, 3): 35259,
        (2023, 4): 38994,
        (2023, 5): 50420,
        (2023, 6): 54819,
        (2023, 7): 35127,
        (2023, 8): 22605,
        (2023, 9): 28360,
        (2023, 10): 18285,
        (2023, 11): 14435,
        (2023, 12): 20963,
    },
    'Туркестанская область': {
        (2025, 1): 46262,
        (2025, 2): 41319,
        (2025, 3): 79058,

        (2024, 1): 32703,
        (2024, 2): 35166,
        (2024, 3): 37685,
        (2024, 4): 41908,
        (2024, 5): 67247,
        (2024, 6): 58391,
        (2024, 7): 53174,
        (2024, 8): 48300,
        (2024, 9): 59249,
        (2024, 10): 73632,
        (2024, 11): 69418,
        (2024, 12): 73774,
        
        (2023, 1): 34451,
        (2023, 2): 36596,
        (2023, 3): 38509,
        (2023, 4): 37332,
        (2023, 5): 47639,
        (2023, 6): 51785,
        (2023, 7): 37185,
        (2023, 8): 37687,
        (2023, 9): 45039,
        (2023, 10): 44875,
        (2023, 11): 40672,
        (2023, 12): 46717,
    },
    'область Ұлытау': {
        (2025, 1): 3516,
        (2025, 2): 4235,
        (2025, 3): 5377,

        (2024, 1): 6649,
        (2024, 2): 10913,
        (2024, 3): 6641,
        (2024, 4): 4666,
        (2024, 5): 6101,
        (2024, 6): 6776,
        (2024, 7): 7335,
        (2024, 8): 8413,
        (2024, 9): 12809,
        (2024, 10): 95179,
        (2024, 11): 5376,
        (2024, 12): 5572,
        
        (2023, 1): 4648,
        (2023, 2): 8144,
        (2023, 3): 6460,
        (2023, 4): 10821,
        (2023, 5): 9299,
        (2023, 6): 5047,
        (2023, 7): 6062,
        (2023, 8): 3326,
        (2023, 9): 3569,
        (2023, 10): 5286,
        (2023, 11): 3935,
        (2023, 12): 7055,
    }
}



@pytest.fixture(scope="session")
def db_config():
    """
    Возвращает конфигурацию подключения к БД из переменных окружения.
    Переменные по умолчанию можно переопределить при запуске.
    """
    return {
        "host": os.getenv("DB_HOST", "13.60.76.175"),
        "port": os.getenv("DB_PORT", "5432"),
        "dbname": os.getenv("DB_NAME", "trade_new_2025"),
        "user": os.getenv("DB_USER", "postgres"),
        "password": os.getenv("DB_PASSWORD", "forestlampsilver"),
    }

    # return {
    #     "host": os.getenv("DB_HOST", "localhost"),
    #     "port": os.getenv("DB_PORT", "5432"),
    #     "dbname": os.getenv("DB_NAME", "trade_v2"),
    #     "user": os.getenv("DB_USER", "postgres"),
    #     "password": os.getenv("DB_PASSWORD", "123654"),
    # }

@pytest.fixture(scope="session")
def db_connection(db_config):
    """
    Устанавливает соединение с базой данных на уровне сессии pytest.
    После завершения тестов соединение закрывается.
    """
    conn = psycopg2.connect(
        host=db_config["host"],
        port=db_config["port"],
        dbname=db_config["dbname"],
        user=db_config["user"],
        password=db_config["password"],
    )
    yield conn
    conn.close()

@pytest.fixture(scope="function")
def cursor(db_connection):
    """
    Создает курсор для каждого тестового случая.
    После теста выполняет rollback, чтобы не сохранять изменения.
    """
    cur = db_connection.cursor()
    yield cur
    db_connection.rollback()
    cur.close()

def test_connection(cursor):
    """
    Проверка базового запроса: SELECT 1
    """
    cursor.execute("SELECT 1;")
    result = cursor.fetchone()
    assert result[0] == 1


import pytest
import math

@pytest.mark.parametrize("region, year, month, expected_int", [
    (region, year, month, expected)
    for region, values in EXPECTED_IM_VALUES.items()
    for (year, month), expected in values.items()
])
def test_sum_im_value_for_region_each_month_integer_part(cursor, region, year, month, expected_int):
    query = f"""
        SELECT SUM(d.import_value)
        FROM data d
        JOIN regions r ON d.region_id = r.id
        JOIN countries c ON d.country_id = c.id
        JOIN tn_veds tv ON d.tn_ved_id = tv.id
        WHERE r.name = %s
        AND d.year = %s
        AND d.month = %s
        AND tv.digit = {digit}
        AND c.name_ru NOT IN ('Россия', 'Кыргызстан', 'Армения', 'Беларусь');
    """
    cursor.execute(query, (region, year, month))
    result = cursor.fetchone()
    
    assert result is not None, f"{year}-{month} {region}: Query returned no result"
    actual_value = result[0]
    assert actual_value is not None, f"{year}-{month} {region}: Query returned NULL"

    actual_int = math.trunc(actual_value)

    assert abs(actual_int - expected_int) <= 6, (
        f"{year}-{month} {region}: expected ~{expected_int} (±6), got {actual_int} from {actual_value} error {expected_int - actual_int}"
    )


@pytest.mark.parametrize("region, year, month, expected_int", [
    (region, year, month, expected)
    for region, values in EXPECTED_IM_VALUES_CU.items()
    for (year, month), expected in values.items()
])
def test_sum_im_value_for_cu_countries_only(cursor, region, year, month, expected_int):
    query = f"""
        SELECT SUM(d.import_value)
        FROM data d
        JOIN regions r ON d.region_id = r.id
        JOIN countries c ON d.country_id = c.id
        JOIN tn_veds tv ON d.tn_ved_id = tv.id
        WHERE r.name = %s
        AND d.year = %s
        AND d.month = %s
        AND tv.digit = {digit}
        AND c.name_ru IN ('Россия', 'Кыргызстан', 'Армения', 'Беларусь');
    """
    cursor.execute(query, (region, year, month))
    result = cursor.fetchone()

    assert result is not None and result[0] is not None, f"{year}-{month}: No data returned"

    actual_decimal = result[0]
    actual_int = math.trunc(actual_decimal)

    assert abs(actual_int - expected_int) <= 6, (
        f"{year}-{month}: expected exactly {expected_int}, got {actual_int} from {actual_decimal} error {expected_int - actual_int}"
    )
